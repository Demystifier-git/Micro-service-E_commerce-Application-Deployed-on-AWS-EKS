name: Deploy to VM server

on:
  push:
    branches:
      - main

permissions:
  actions: write   # Allows triggering other workflows
  contents: read   # Needed for checkout

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Configure SSH
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEV_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEV_SERVER_IP }} >> ~/.ssh/known_hosts

      # 3. Sync code to server
      - name: Sync code to server
        run: |
          rsync -avz \
            --exclude=".git" \
            --exclude="vendor" \
            --exclude="node_modules" \
            ./ \
            ${{ secrets.DEV_SSH_USER }}@${{ secrets.DEV_SERVER_IP }}:${{ secrets.DEV_APP_PATH }}/

